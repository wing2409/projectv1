<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:w2="http://www.inswave.com/websquare">
<head>
<meta http-equiv=Content-Type content="text/html;charset=UTF-8" />
<meta http-equiv=Cache-Control content=No-Cache />
<meta http-equiv=Pragma	content=No-Cache />
<title>FILE UPLOAD</title>
<script type="text/javascript" src="../../../message/htmlCommon.js"></script>
<script language="JavaScript">
	var vActionUrl		= "";
	var vCallbackMethod	= "";
    var domain = "";
    var processMsg = "";
    var columnIds = "";
    
	window.onload = doInit;
	function doInit() {
        try {
            domain = getParameter("domain");  
            if(domain) {
                document.domain = domain;   
            }
        } catch (e) {
        	//$l("exception:" + e.message);
        }

        //  header, append, hidden, columnNum, hiddenColumns, action
		vheader = getParameter("header");
		vfooter = getParameter("footer");
		vappend = getParameter("append");
		vhidden = getParameter("hidden");
		vcolumnNum = getParameter("columnNum");
		vhiddenColumns = getParameter("hiddenColumns");
		vremoveColumns = getParameter("removeColumns");
		vheaderRows = getParameter("headerRows");
		actionUrl = getParameter("action");
		delim = getParameter("delim");
		gridID = getParameter("gridID");
		fillHidden = getParameter("fillHidden");
		gridStartRow = getParameter("gridStartRow");
		gridStartCol = getParameter("gridStartCol");
		gridEndCol = getParameter("gridEndCol");
		gridSheetNo = getParameter("gridSheetNo");
		expressionColumns = getParameter("expressionColumns");
		type = getParameter("type");
		skipSpace = getParameter("skipSpace");
		var insertColumns = getParameter("insertColumns");
		processMsg = getParameter("processMsg");
		processMsg = opener.WebSquare.text.BASE64URLDecoder(processMsg );
		dataList = getParameter("dataList");
		columnIds = getParameter("columnIds");

		document.getElementById("header").value = vheader;
		//document.getElementById("footer").value = vfooter;
		document.getElementById("columnNum").value = vcolumnNum;
		document.getElementById("hiddenColumns").value = vhiddenColumns;
		document.getElementById("removeColumns").value = vremoveColumns;
		document.getElementById("headerRows").value = vheaderRows;
        document.getElementById("domain").value = domain;

        //row를 가져오는 것을 좀더 좋은 방법으로 수정해야 한다. 
		var el = opener.WebSquare.xml.getElementsByTagName(opener[gridID].element, "w2:gBody");
		var rows =opener.WebSquare.xml.getElementsByTagName(el[0],"w2:row");
		var myrows = rows.length;
		document.getElementById("bodyRows").value = myrows;
		var myhidden =document.getElementsByName("hidden");
	
		//vhidden 처리
		if( typeof vhidden == "string") {
			vhidden  = opener.WebSquare.util.getBoolean(vhidden);
		}
		
		if( vhidden ) {
			myhidden[0].options[0].selected = true;
		} else {
		 	myhidden[0].options[1].selected =true;
		}

		document.getElementById("delim").value = delim;
		//document.getElementById("fillHidden").value = fillHidden;
		var myfillHidden =document.getElementsByName("fillHidden");
		//fillhiden 처리 		
			
		if( typeof fillHidden == "string" ) {
			fillHidden  = opener.WebSquare.util.getBoolean(fillHidden);
		}
		
		if( fillHidden ) {
			myfillHidden[0].options[0].selected = true;
		} else {
		 	myfillHidden[0].options[1].selected =true;
		}
		
		var skip_space =document.getElementsByName("skip_space");
		//skipSpace 처리
		if( typeof skipSpace == "string" ) {
			skipSpace  = opener.WebSquare.util.getBoolean(skipSpace);
		}
		
		if( skipSpace ) {
			skip_space[0].options[0].selected = true;
		} else {
			skip_space[0].options[1].selected = true;
		}

		var footer_Exist =document.getElementsByName("footer");
		//skipSpace 처리
		if( typeof vfooter == "string" ) {
			vfooter  = opener.WebSquare.util.getBoolean(vfooter);
		}
		
		if( vfooter ) {
			footer_Exist[0].options[0].selected = true;
		} else {
			footer_Exist[0].options[1].selected = true;
		}

		document.getElementById("gridStartRow").value = gridStartRow;
		document.getElementById("gridStartCol").value = gridStartCol;
		document.getElementById("gridEndCol").value = gridEndCol;
		document.getElementById("gridSheetNo").value = gridSheetNo;
		
		document.getElementById("expressionColumns").value = expressionColumns;
		//grid style을 전송한다. 
		document.getElementById("gridStyle").value = opener.WebSquare.xml.noNameSpaceSerialize(opener[gridID].element);
		document.getElementById("insertColumns").value = insertColumns;
		
		with( document.__uploadForm__ ) {
			action = actionUrl;
		}

        if(isSafari) {
            setTimeout(function() {
                var bottomMargin = parseInt(document.height - document.documentElement.offsetHeight, 10) * -1||0;     
                if( bottomMargin != 0 ) {
                    self.resizeBy(0, bottomMargin);
                }
            }, 1);
        }
	}
	
	function upload( thisForm ) {
		try {
			var filename = document.getElementById("filename").value;
			if( !filename || filename =="" ) {
				return false;
			}
			
			var isXlsFile = filename.toLowerCase().indexOf(".xls") >= 0;
			var isXlsType = document.__uploadForm__.action.indexOf("excelToGrid") >= 0;
			var isCSVFile = endsWith(filename.toLowerCase(), ".csv") >= 0 ||
							endsWith(filename.toLowerCase(), ".txt") >= 0;
			var isCSVType = document.__uploadForm__.action.indexOf("csvToXML") >= 0;
			if( !(isXlsFile && isXlsType) && !(isCSVFile && isCSVType) ) {
				alert( "FileType에 맞지 않는 File의 확장자입니다." );
				return false;
			}

			var frm = window.frames;
			var find = false;
			for( var i = 0; i < frm.length; i++ ) {
			    if( frm[i].name == thisForm.target ) {
			    	find = true;
			    }
			}
			
			if( !find ) {
				var layerUP= document.createElement("div");
				var src = "";
				//alert(layerUP);
				layerUP.style.border="1px solid blue";
				layerUP.style.width="100px";
				layerUP.style.height="100px";
				layerUP.style.visibility = "hidden";
				document.body.appendChild(layerUP);
				src = opener.WebSquare.net.getSSLBlankPage();
				layerUP.innerHTML = "<iframe frameborder='0px' name='" + thisForm.target + "' scrolling='no' style='width:100px; height:100px' " + src + "></iframe>";
			}
			
			showProcessMessage( processMsg );
			
			thisForm.submit();
		} catch(e) {
			alert(e.description);
		}
	}

	function returnData( vData ) {
		
		if( processMsg != "" ) {
			hideProcessMessage();
		}

		var doc = opener.WebSquare.xml.parse( vData );
		var exception = doc.getElementsByTagName("Exception");

		if( exception.length > 0) {
			var code = doc.getElementsByTagName("deniedCodeList")[0].firstChild;
			if( typeof code == "undefined" || code == null || code == "" ) {
				code = "";	
			} else {
				code = code.nodeValue;
			}

			if( code == "102" ) {
				msg = "파일 사이즈가 제한 용량을 초과 하였습니다.";
			} else {
				var msg = doc.getElementsByTagName("message")[0].firstChild;
				if( typeof msg == "undefined" || msg == null || msg == "" ) {
					msg = "정상적으로 처리 되지 않았습니다.";
				} else {
					msg = msg.nodeValue;
				}
			}
			
			alert(msg);
		} else { 
			var child = (doc.getElementsByTagName("array"))[0].firstChild.nodeValue;

	//		var child = child.substring(2,child.length-3); //.split("\",\"");
			
			if( typeof vappend =="string" ) {
				vappend = opener.WebSquare.util.getBoolean(vappend);
			}
			
			//WebSquare.logger.showObject(child);
			var compId = "";
			
			try {

				var jsonArray = {
						columnInfo:columnIds.split(","),
						data:child
		     	}
				if( dataList != "" ) {
					compId = "$w.data." + dataList;
					
					if (type == "true" ){
						eval( "opener." + compId + ".setArrayFile(jsonArray, vappend, gridID)" );
					 }else{
						eval( "opener." + compId + ".setArray(jsonArray, vappend)" );
					 }
					
				} else {
					compId = gridID;

					if (type == "true" ){
						eval( "opener." + compId + ".setDataFile(child, vappend)" );
					}else{
						eval( "opener." + compId + ".setData(child, vappend)" );
					}
				}

				var fileNameDom = document.getElementById("filename")
				var fileName = fileNameDom.value;
				var fileNameArr = fileName.split("\\"); //fileName에 대해서 IE에서는 파일 경로가 나오는데 FF chrome은 나오지 않는다. 따라서 '\\'기준으로 나눠준다.
				eval( 'opener.' + gridID + '.fireFileReadEnd("'+fileNameArr[fileNameArr.length-1]+'")' );
				window.self.close();
			} catch (e) {
				opener.WebSquare.exception.printStackTrace(e);
				alert( "그리드 반영에 실패하였습니다" );			
			}
		}
	}
	
	 function crossBrowserHeight() {
		if(opener.WebSquare.util.isIE(6)) {
			return 119;
		}
		if(opener.WebSquare.util.isIE(7)) {
			return 119;
		} 
		if(opener.WebSquare.util.isIE(8)) {
			return 119;
		} 
		if(opener.WebSquare.util.isIE(9)) {
			return 119;
		} 
		if(opener.WebSquare.util.isFF()) {
			return 120;
		} 
		if(opener.WebSquare.util.isChrome()) {
			return 119;
		} 
		if(opener.WebSquare.util.isSafari()) {
			return 119;
		} 
		if(opener.WebSquare.util.isOpera()) {
			return 119;
		} 
		return 119;
	}
	
	function check_fun() {
		var checkfun = document.getElementById('subcheck').checked;
		if( checkfun == true ) {
			document.getElementById('sub').style.display='block';
			var height = crossBrowserHeight();
			window.resizeBy(0 , height);//resizeBy가 ff7.0에서 안됨 
		} else {
			document.getElementById('sub').style.display='none';
			var height = crossBrowserHeight();
			window.resizeBy(0 ,-1 * parseInt(height));//resizeBy가 ff7.0에서 안됨 
		}
	}
	
	function showProcessMessage( processMsg ) {
		
		try {
			if(!processMsg || processMsg == "" ) { 
				return;
			}

			var processbar2_main = document.getElementById( "___processbar2" );
			var processbar2 = document.getElementById( "___processbar2_i" );
			var processMsgURL = opener.WebSquare.core.getConfiguration( "processMsgURL" );
			var processMsgHeight = opener.WebSquare.core.getConfiguration( "processMsgHeight" );
			var processMsgWidth = opener.WebSquare.core.getConfiguration( "processMsgWidth" );
			var processMsgBackground = opener.WebSquare.core.getConfiguration( "processMsgBackground" );
			var processMsgBackgroundColor = opener.WebSquare.core.getConfiguration( "/WebSquare/processMsgBackground/@backgroundColor" );
			if (processMsgBackgroundColor == ""){
				processMsgBackgroundColor = "#112233";	
			}
			if( processMsgURL == "" ) {
				processMsgURL = opener.WebSquare.baseURI + "message/processMsg.html";
			}
			
			processMsgURL = processMsgURL + "?param=" + opener.WebSquare.text.URLEncoder(processMsg);
			
			if( processMsgHeight == "" || processMsgWidth == "" ) {
				processMsgHeight = "74";
				processMsgWidth = "272";
			}

			WebSquare = opener.WebSquare;
			WebSquare.layer.processMsg = processMsg;
			
			if(!processbar2_main){
				var node2Main = document.createElement( "div" );
				node2Main.id = "___processbar2";
				node2Main.className = "w2modal";
				node2Main.style.backgroundColor = processMsgBackgroundColor;
				node2Main.tabIndex = 1;
				if(processMsgBackground == "true"){
					node2Main.style.visibility = "visible";
				} else{
					node2Main.style.visibility = "hidden";
				}
				
				node2Main.style.height = document.documentElement.clientHeight + "px";
				document.body.appendChild( node2Main );
				
				var e = e || event;
				if( e.preventDefault ) {
					if( e.type == "keydown" ) {
						e.preventDefault();
					}
				} else {
					if( e.type == "keydown" ) {
						e.returnValue = false;
					}
				}
				
			} else {
				processbar2_main.tabIndex = 1;
				processbar2_main.style.zIndex = 10000;
				processbar2_main.style.display = "block";
				processbar2_main.style.top = "0px";
				processbar2_main.style.left = "0px";
			}

			if( !processbar2 ) {
				var nTop = document.documentElement.scrollTop + document.documentElement.clientHeight/2 - parseInt(processMsgHeight)/2;
				var nLeft = document.documentElement.scrollLeft + document.documentElement.clientWidth/2 - parseInt(processMsgWidth)/2;

				var node2 = document.createElement("div");
				node2.id = "___processbar2_i";
				node2.style.position = "absolute";
				node2.style.top = parseInt(nTop) + "px";
				node2.style.left = parseInt(nLeft) + "px";
				node2.style.overflow = "hidden";
				node2.style.zIndex = 10001;
				node2.style.visibility = "visible";
				node2.style.height = processMsgHeight + "px";
				node2.style.width = processMsgWidth + "px";

				document.body.appendChild( node2 );
				node2.innerHTML = "<iframe frameborder='0' scrolling='no'ß name='__processbarIFrame' style='position:absolute; width:"+processMsgWidth+"px; height:"+ processMsgHeight +"px; top:0px; left:0px' src='" + processMsgURL + "'></iframe>";
				
			} else {
				var nTop = document.documentElement.scrollTop + document.documentElement.clientHeight/2 - parseInt(processMsgHeight)/2;
				var nLeft = document.documentElement.scrollLeft + document.documentElement.clientWidth/2 - parseInt(processMsgWidth)/2;
				processbar2.style.top = parseInt(nTop) + "px";
				processbar2.style.left = parseInt(nLeft) + "px";
				processbar2.style.zIndex = 10001;
				window.frames["__processbarIFrame"].location.replace( processMsgURL );
				processbar2.style.display = "block";
			} 
		} catch( e ) {
		}
	}
	
	function hideProcessMessage() {
		try {
			var processbar2 = document.getElementById( "___processbar2" );
			var processbar2i = document.getElementById( "___processbar2_i" );
			if( typeof processbar2 != "undefined" && processbar2 != null ) {
				processbar2.style.zIndex = -1;
				processbar2.style.display = "none";
				processbar2.tabIndex = "-1";
				processbar2.innerHTML = '';
			}
			if( typeof processbar2i != "undefined" && processbar2i != null ) {
				processbar2i.style.zIndex = -1;
				processbar2i.style.display = "none";
			}
		} catch( e ) {
		}
	}
</script>

<style type="text/css">
    html, body {margin:0px; padding:0px; font-family:"맑은 고딕"; font-size:11px;}
    p {margin:0px; padding:0px;}
	img, fieldset {border:0;}
	table {width:100%; background:#fff; border-collapse:collapse; border-spacing:0; empty-cells:show;}
	table caption, table summary {width:0; height:0; font-size:0; line-height:0; overflow:hidden; visibility:hidden;}
	
	.none {display:none;}
	.block {display:block;}

	.wrap {width:444px; min-height:106px; border:1px solid #b3b3b3;}
	.header {height:27px; background:url(images/bg_header.gif) repeat-x left top;}
	.header .title {padding-left:28px; font-weight:bold; line-height:23px; background:url(images/bul_title.gif) no-repeat 11px 6px; float:left;}
	.header span {padding-right:20px; float:right; display:block;}
	.header span input[type=checkbox] {position:relative; top:1px;}

	.content {padding:15px 10px 12px;}
	.content .filebox {padding:8px 0 0 11px; width:408px; height:33px; border:1px solid #d3d3d3; background:#f6f6f6;}
	.content .filebox input[type=file] {width:397px; height:21px; font-family:Verdana; font-size:12px; background:#fff;}

	.tbl {margin:15px auto 0; width:400px;}
	.tbl th, .tbl td {min-width:100px; height:24px; text-align:left;}
	.tbl th .dot {padding-left:14px; background:url(images/dot.gif) no-repeat left center;}
	.tbl td .ipt {width:74px; height:16px; /*bordeR:1px solid #abadb3;*/}
	.tbl td .sel {width:80px; height:20px;}
	.btn_file {margin-bottom:14px; width:90px; position:relative; left:333px;}
</style>
</head>
<body>
<form name="__uploadForm__" method="post" action="" enctype="multipart/form-data" target="__targetFrame__">
	
	<div class="wrap">
		<div class="header">
			<p class="title">File Upload</p>
			<span><input type="checkbox" onclick="check_fun();" id="subcheck" /><label for="subcheck"><img src="images/text.gif" alt="고급설정" /></label></span>
		</div>
		<div class="content">
			<div class="filebox">
				<input type="file" id="filename" name="filename" />
			</div>
			<table id="sub" class="tbl none" summary="공백무시,히든값유무,히든채움,푸터유무,시작Row,시작col,시트no">
			<caption>파일 업로드 고급설정</caption>
				<tr>
					<th><label for="spaceSelect" class="dot">공백 무시 :</label></th>
					<td>
						<select name="skip_space" class="sel" id="spaceSelect">
						<option value="true">공백무시</option>
						<option value="false">공백포함</option>
						</select>
					</td>
					<th><label for="gridStartRow" class="dot">시작 Row :</label></th>
					<td>
						<input type="text" id="gridStartRow" name="gridStartRow" class="ipt" />
					</td>
				</tr>
				<tr>
					<th><label for="hiddenSelect" class="dot">히든값유무 :</label></th>
					<td><select name="hidden" id="hiddenSelect" class="sel">
						<option value="true">포함</option>
						<option value="false">미포함</option>
						</select>
					</td>
					<th><label for="gridStartCol" class="dot">시작 Col :</label></th>
					<td>
						<input type="text" class="ipt" name="gridStartCol" id="gridStartCol" />
					</td>
				</tr>
				<tr>
					<th><label for="fillHidden" class="dot">히든 채움 :</label></th>
					<td>
						<select name="fillHidden" id="fillHidden">
						<option value="true">채움</option>
						<option value="false">무시</option>
						</select>
					</td>
					<th><label for="gridSheetNo" class="dot">시트 No :</label></th>
					<td><input type="text" class="ipt" name="gridSheetNo" id="gridSheetNo" /></td>
				</tr>  
				<tr>
					<th><label for="footer" class="dot">푸터 유무 :</label></th>
					<td>
						<select name="footer" id="footer">
						<option value="true">포함</option>
						<option value="false">미포함</option>
						</select>
					</td>
					<th>&nbsp;</th>
					<td>&nbsp;</td>
				</tr> 
			</table>
		</div>
		
		<div class="foot">
			<p><input type="button" name="sendFILE" class="btn_file" value="파일 업로드" onclick="return upload(this.form)" /></p>
			<!-- ie8에서는 form안에 input type="image"가 있으면 form전송이 제대로 되지 않습니다. -->	
		</div>

	</div>
  <!-- working start -->
  <input type="hidden" id="domain" name="domain" value="" />
  <input type="hidden" id="header" name="header" value="1" />
  <input type="hidden" id="footer" name="footer" value="1" />
  <input type="hidden" id="columnNum" name="columnNum" value="" />
  <input type="hidden" id="hiddenColumns" name="hiddenColumns" value="" />
  <input type="hidden" id="removeColumns" name="removeColumns" value="" />
  <input type="hidden" id="headerRows" name="headerRows" value="" />
  <input type="hidden" id="bodyRows" name="bodyRows" value="" />
  <!-- input type="hidden" id="hidden" name="hidden" value=""/ -->
  <input type="hidden" id="delim" name="delim" value="" />
  <input type="hidden" id="fillHidden" name="fillHidden" value="" />
  <input type="hidden" id="expressionColumns" name="expressionColumns" value="CC" />
  <input type="hidden" id="gridStyle" name="gridStyle" value="" />
  <input type="hidden" id="insertColumns" name="insertColumns" value="" />
  <input type="hidden" id="gridEndCol" name="gridEndCol" value="" />
</form>

</body>
</html>